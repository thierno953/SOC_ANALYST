# Matching Obfuscated Code

#### Purpose

- This YARA rule detects simple obfuscation techniques commonly used by malware to evade detection, including:

  - Anti-debugging patterns

  - Control flow obfuscation

  - Hidden encoded strings

  - Suspicious memory allocation.

#### Step 1: Create the YARA Rule

```sh
nano task4.yar
```

```sh
rule Simple_Obfuscated_Malware {
  meta:
    description = "Detects basic obfuscation techniques in malware"
    author = "Security Team"
    date = "2025-01-05"
    severity = "high"
    reference = "https://example.com"

  strings:
    $anti_debug_pattern = { C3 CC CC CC }
    $control_flow_obfuscation = { EB 05 90 }  // Short jump + NOP (used in junk code)
    $api_virtualalloc = "VirtualAlloc"
    $encoded_string = "HiddenData" ascii wide nocase

  condition:
    ($anti_debug_pattern and $control_flow_obfuscation) or ($api_virtualalloc and $encoded_string)
}
```

#### Explanation:

- `$anti_debug_pattern`: Sequence used to break debuggers (e.g., `RET + INT 3`)

- `$control_flow_obfuscation`: Junk instructions that disrupt control flow analysis.

- `$api_virtualalloc`: Memory allocation, often for injecting/decrypting payloads.

- `$encoded_string`: A placeholder hidden string embedded in the binary.

#### Step 2: Create the Sample File

```sh
nano file4.txt
```

```sh
--- BEGIN FILE HEADER ---
File ID: SIMPLE-MALWARE-2025
Timestamp: 2025-01-14T14:30:00Z
Threat Level: HIGH
Malware Type: Obfuscated Sample

--- SYSTEM INFORMATION ---
Operating System: Windows 10
User: SYSTEM

--- CODE SECTION ---
0x00401000: C3
0x00401001: CC CC CC
0x00401004: 90
0x00401005: EB 05
0x00401007: 90 90

--- MEMORY ALLOCATION ---
0x00402000: CALL VirtualAlloc ; Allocate memory for future code injection

--- HIDDEN STRINGS ---
Encode String: HiddenData (placeholder for sensitive data)

--- NETWORK CONNECTION ---
IP Address: 192.168.1.0
Port: 8080

--- FILE FOOTER ---
Checksum: SHA-256: D3F8+6E
Verification: Non-malicious educational file (used for demonstration purposes)
```

#### Step 3: Run the YARA Rule

- To match the rule:

```sh
yara task4.yar file4.txt
```

- To show string matches:

```sh
yara -s task4.yar file4.txt
```
