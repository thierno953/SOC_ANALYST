# Detecting Packed Executables

#### Purpose

- This YARA rule is designed to detect executables that use packing techniques to hide malicious behavior. Packed executables often use obfuscated code, encryption routines, suspicious API calls, and embedded IP addresses to bypass detection.

#### Step 1: Create the YARA Rule

- Create the YARA rule file:

```sh
nano task3.yar
```

```sh
rule Packed_Executable {
  meta:
    description = "Detects executables using packing techniques"
    author = "Security Team"
    date = "2025-01-05"
    severity = "high"

  strings:
    $unpack_sequence1 = { 60 BE 45 23 11 00 8B FC F3 A5 }
    $unpack_sequence2 = { 55 8B EC 81 EC ?? ?? ?? ?? 8D ?? ?? ?? }
    $api_virtualalloc = "VirtualAlloc"
    $api_writeprocessmemory = "WriteProcessMemory"
    $api_setthreadcontext = "SetThreadContext"
    $api_createremotethread = "CreateRemoteThread"
    $network_connection = "192.168.33.45"

  condition:
    any of them
}
```

#### Explanation:

- `unpack_sequence1` and `unpack_sequence2`: Known hexadecimal signatures of unpacking routines.

- `VirtualAlloc`, `WriteProcessMemory`, etc.: APIs often used for code injection or process hollowing.

- `192.168.33.45`: A suspicious hardcoded IP for outbound connections.

#### Step 2: Create a Sample Test File

```sh
nano file3.txt
```

```sh
--- BEGIN FILE HEADER ---
File ID: PACK-EXEC-2025
Timestamp: 2025-01-14T13:45:00Z
Threat Level: HIGH
Malware Type: Packed Executable

--- SYSTEM INFORMATION ---
Operating System: Windows 10 Pro
Affected User: SYSTEM
Memory Dump ID: 0xB9ACD934

--- PACKED PAYLOAD SEQUENCE ---
This packed executable contains obfuscated code to evade detection.
Unpacking routine initiatives with the following sequences:

Signature Hex Codes:
1. 60 BE 45 23 11 00 8B FC F3 A5
2. 55 8B EC 81 EC ?? ?? ?? ?? 8D ?? ?? ??

Unpacking Process:
  - Stores original registers and prepares stack frame for decryption.
  - Loads encoded payload at virtual memory address 0x00412c80.
  - Executes a loop to decrypt each byte using XOR-based encryption.

--- EXECUTION LOG ---
Entry 1:
    Address: 0x00412D0
    Function: Initialize (Hex: 60 BE ?? ?? ?? ?? 8B FC F3 A5)
    Description: Sets up unpacking code and memory allocation.

Entry 2:
    Address: 0x004012F5
    Function: Decrypt Routine
    Description: Begins decryption with obfuscated code sequence.

--- MALICIOUS BEHAVIOR INDICATORS ---
Detected API Calls:
  - VirtualAlloc
  - WriteProcessMemory
  - SetThreadContext
  - CreateRemoteThread

--- FILE CHECKSUM ---
SHA-256: E99A18C428CB38D5F260853678922E03
Verification Status: Malicious Signature Detected

--- NETWORK TRAFFIC LOG ---
Outbound Connection:
  IP Address: 192.168.33.45
  Port: 443
  Protocol: HTTPS
```

#### Step 3: Scan the File with YARA

- To detect the presence of packed indicators:

```sh
yara task3.yar file3.txt
```

- To show matching strings and their offsets:

```sh
yara -s task3.yar file3.txt
```
